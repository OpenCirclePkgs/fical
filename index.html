<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.84.0">
    <title>fiCal - Simple iCal filtering</title>

    <!-- Bootstrap core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <style>
        * {
            box-sizing: border-box;
        }
        body {
            background-color: #f8f9fa;
        }
        .header-section {
            background-color: white;
            padding: 3rem 0;
            border-bottom: 1px solid #dee2e6;
        }
        .form-section {
            background-color: white;
            padding: 3rem 0;
        }
        .explanation-section {
            background-color: #f8f9fa;
            padding: 3rem 0;
        }
        .calendar-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
        }
        .url-input-wrapper {
            width: 100%;
            flex-shrink: 0;
        }
        .url-input-wrapper input {
            width: 100%;
        }
        .filter-inputs-wrapper {
            display: flex;
            flex-direction: row;
            gap: 0.75rem;
            width: 100%;
            flex-shrink: 0;
        }
        .filter-inputs-wrapper > div {
            flex: 1 1 50%;
            min-width: 0;
        }
        .filter-inputs-wrapper > div input {
            width: 100%;
        }
        @media (min-width: 576px) {
            .calendar-input-group {
                flex-direction: row;
                gap: 0.75rem;
            }
            .url-input-wrapper {
                flex: 1 1 50%;
                min-width: 0;
            }
            .filter-inputs-wrapper {
                flex: 1 1 50%;
                gap: 0.75rem;
            }
            .filter-inputs-wrapper > div {
                flex: 1 1 0%;
                min-width: 0;
            }
            input.form-control {
                font-size: 1rem;
                padding: 0.75rem;
            }
        }
        @media (min-width: 992px) {
            .form-section {
                padding: 4rem 0;
            }
            .form-container {
                max-width: 700px;
                margin: 0 auto;
            }
        }
        .card {
            border: 1px solid #dee2e6;
        }
        .btn-group-custom {
            display: flex;
            gap: 0.5rem;
        }
    </style>
</head>
<body>

<main>
    <!-- Header Section -->
    <section class="header-section">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h1 class="display-4 fw-bold lh-1 mb-3">Simple iCal filtering</h1>
                    <p class="fs-5 mb-2">Filter unwanted iCal events. Load an existing link to edit, or craft new filters below.</p>
                    <p class="fs-5">Add one or more calendar subscription URLs with their allow/block filters, then subscribe to the generated link. You can optionally create a short link for the bundle.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Form Section -->
    <section class="form-section">
        <div class="container">
            <div class="form-container">
                <form class="p-4 p-md-5 border rounded-3 bg-light">
                    <!-- Load Existing Link -->
                    <div class="mb-4">
                        <h5 class="mb-3">Load Existing Link (Optional)</h5>
                        <div class="form-floating mb-2">
                            <input type="url" class="form-control" id="existinglink">
                            <label for="existinglink">Existing filtered link</label>
                        </div>
                        <small class="text-muted d-block mb-3">Paste a filtered link to load and edit it</small>
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="loadExistingLink()">Load link into editor</button>
                    </div>

                    <hr class="my-4">

                    <!-- Calendars Section -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Calendars (max 5)</h5>
                            <div class="btn-group-custom">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCalendarRow()">Add</button>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCalendarRow()">Remove</button>
                            </div>
                        </div>
                        <div id="multi-cal-list"></div>
                    </div>

                    <!-- Short Link Checkbox -->
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="multishorten">
                        <label class="form-check-label" for="multishorten">
                            Create short link for calendar(s)
                        </label>
                    </div>

                    <!-- Generate Button -->
                    <button type="button" class="w-100 btn btn-lg btn-success mb-4" onclick="generateCombined()">Generate</button>

                    <!-- Output Section -->
                    <div class="mb-4">
                        <div class="form-floating mb-2">
                            <input type="url" class="form-control" id="combinedOutput" readonly>
                            <label for="combinedOutput">Calendar link (short or downloadable)</label>
                        </div>
                        <button type="button" class="btn btn-primary w-100 mb-2" id="copyCombined" onclick="copyCombined()" disabled>Copy link</button>
                        <small class="text-muted d-block">When not using short links a temporary download link is generated for the merged calendar.</small>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Explanation Section -->
    <section class="explanation-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <h3 class="mb-3">How does it work?</h3>
                    <p class="lead text-muted mb-3">On every request the remote iCal file is fetched directly from the remote server and parsed, after that the calendar is returned as-is with only events that match the allowed keywords and do not contain any of the blocked words. All the data about the request is stored in the URL and is never stored on the server. If you enable short links, request data is cached locally to provide a shorter URL. You can also combine up to five calendars with their own filters and optionally request a short link for the bundle.</p>
                    <p class="lead text-muted">The code is open source under MIT license and available on <a href="https://github.com/OpenCirclePkgs/fical">GitHub</a></p>
                </div>
            </div>
        </div>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

<script>
    const EMPTY_ALLOWLIST_TOKEN = "__empty_allowlist__"
    const MAX_CAL = 5
    const multiCalList = []

    function onInputHandler() {
        document.getElementById("combinedOutput").value = ""
        document.getElementById("copyCombined").disabled = true
    }

    function loadExistingLink() {
        const link = document.getElementById("existinglink").value.trim()
        if (!link) return
        try {
            const url = new URL(link)
            const parts = url.pathname.split("/")
            if (parts.length >= 4 && parts[1] === "calendar") {
                const encodedUrl = parts[2]
                const encodedAllow = parts[3]
                const blockParam = url.searchParams.get("b64blocklist") || ""
                const allowDecoded = decodeFromBase64url(encodedAllow)
                addCalendarRow({
                    url: decodeFromBase64url(encodedUrl),
                    allowlist: allowDecoded === EMPTY_ALLOWLIST_TOKEN ? "" : allowDecoded,
                    blocklist: blockParam ? decodeFromBase64url(blockParam) : ""
                })
                onInputHandler()
            } else if (parts.length >= 3 && parts[1] === "s") {
                document.getElementById("combinedOutput").value = link
                document.getElementById("copyCombined").disabled = false
            }
        } catch (e) {
            alert("Could not parse link")
        }
    }

    function addCalendarRow(prefill = {}) {
        if (multiCalList.length >= MAX_CAL) {
            alert("Maximum of 5 calendars")
            return
        }
        const idx = multiCalList.length
        const container = document.createElement("div")
        container.className = "card p-3 mb-3"
        container.id = `multi-${idx}`

        const urlCol = document.createElement("div")
        urlCol.className = "url-input-wrapper"
        const urlInput = document.createElement("input")
        urlInput.type = "url"
        urlInput.className = "form-control"
        urlInput.placeholder = "Calendar URL"
        urlInput.setAttribute("data-field", "url")
        urlInput.value = prefill.url || ""
        urlInput.oninput = onInputHandler
        urlCol.appendChild(urlInput)

        const filterRow = document.createElement("div")
        filterRow.className = "filter-inputs-wrapper"

        const allowCol = document.createElement("div")
        const allowInput = document.createElement("input")
        allowInput.type = "text"
        allowInput.className = "form-control"
        allowInput.placeholder = "Allowlist (comma)"
        allowInput.setAttribute("data-field", "allowlist")
        allowInput.value = prefill.allowlist || ""
        allowInput.oninput = onInputHandler
        allowCol.appendChild(allowInput)

        const blockCol = document.createElement("div")
        const blockInput = document.createElement("input")
        blockInput.type = "text"
        blockInput.className = "form-control"
        blockInput.placeholder = "Blocklist (comma)"
        blockInput.setAttribute("data-field", "blocklist")
        blockInput.value = prefill.blocklist || ""
        blockInput.oninput = onInputHandler
        blockCol.appendChild(blockInput)

        filterRow.appendChild(allowCol)
        filterRow.appendChild(blockCol)

        const mainRow = document.createElement("div")
        mainRow.className = "calendar-input-group"
        mainRow.appendChild(urlCol)
        mainRow.appendChild(filterRow)
        container.appendChild(mainRow)
        document.getElementById("multi-cal-list").appendChild(container)
        multiCalList.push(container)
    }

    function resetCalendarRows() {
        while (multiCalList.length) {
            const el = multiCalList.pop()
            el.remove()
        }
    }

    function removeCalendarRow() {
        const el = multiCalList.pop()
        if (el) {
            el.remove()
        }
    }

    function withDefaultAllowlist(list) {
        return list.length ? list : [EMPTY_ALLOWLIST_TOKEN]
    }

    async function generateCombined() {
        const payload = {calendars: [], short: document.getElementById("multishorten").checked}

        multiCalList.forEach(card => {
            const url = card.querySelector('[data-field="url"]').value.trim()
            const allowlist = card.querySelector('[data-field="allowlist"]').value.split(",").map(s => s.trim()).filter(Boolean)
            const blocklist = card.querySelector('[data-field="blocklist"]').value.split(",").map(s => s.trim()).filter(Boolean)
            if (url) {
                payload.calendars.push({url, allowlist: withDefaultAllowlist(allowlist), blocklist})
            }
        })

        if (!payload.calendars.length) {
            alert("Add at least one calendar")
            return
        }
        if (payload.calendars.length > MAX_CAL) {
            alert("Maximum of 5 calendars")
            return
        }
        let resp
        try {
            resp = await fetch("/calendars/combined.ics", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            })
        } catch (e) {
            alert("Network error while generating combined calendar")
            return
        }
        if (!resp.ok) {
            alert("Failed to generate combined calendar")
            return
        }
        if (payload.short) {
            const data = await resp.json()
            document.getElementById("combinedOutput").value = data.short
        } else {
            const blob = await resp.blob()
            const url = URL.createObjectURL(blob)
            document.getElementById("combinedOutput").value = url
        }
        document.getElementById("copyCombined").disabled = !document.getElementById("combinedOutput").value
    }

    function copyCombined() {
        const val = document.getElementById("combinedOutput").value
        if (!val) return
        if (navigator.clipboard) {
            navigator.clipboard.writeText(val)
        }
    }

    function base64ToBase64url(input) {
      return input
        .replace(/\+/g, '_')
        .replace(/\//g, '-')
        .replace(/=+$/g, '');
    }

    function encodeToBase64url(input) {
      const bytes = new TextEncoder().encode(input)
      let binary = ""
      bytes.forEach((b) => {
        binary += String.fromCharCode(b)
      })
      return base64ToBase64url(btoa(binary));
    }

    const sharedTextDecoder = new TextDecoder()

    function decodeFromBase64url(input) {
        let b64 = input.replace(/-/g, "+").replace(/_/g, "/")
        while (b64.length % 4) {
            b64 += "="
        }
        try {
            const binary = atob(b64)
            const bytes = Uint8Array.from(binary, (c) => c.charCodeAt(0))
            return sharedTextDecoder.decode(bytes)
        } catch (_) {
            return ""
        }
    }

    // initialize with one row
    addCalendarRow()
</script>

</body>
</html>
