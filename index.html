<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.84.0">
    <title>fiCal - Simple iCal filtering</title>

    <!-- Bootstrap core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

</head>
<body>

<main>
    <div class="container col-xl-10 col-xxl-8 px-4 py-5">
        <div class="row align-items-center g-lg-5 py-5">
            <div class="col-lg-7 text-center text-lg-start">
                <h1 class="display-4 fw-bold lh-1 mb-3">Simple iCal filtering</h1>
                <p class="col-lg-10 fs-4">Filter unwanted iCal events. Load an existing link to edit, or craft new filters below.</p>
                <p class="col-lg-10 fs-4">On the right side enter the calendar subscription URL, then enter which words
                    are allowed to be in the event names and optionally which ones should be blocked, and subscribe the
                    newly generated URL in your calendar app. You can also combine up to 5 calendars with individual filters.</p>
            </div>
            <div class="col-md-10 mx-auto col-lg-5">
                <form class="p-4 p-md-5 border rounded-3 bg-light">
                    <div class="form-floating mb-3">
                        <input type="url" class="form-control" id="existinglink">
                        <label for="existinglink">Existing filtered link</label>
                        <small class="text-muted">Paste a filtered link to load and edit it</small>
                    </div>
                    <button type="button" class="btn btn-outline-secondary mb-3 w-100" onclick="loadExistingLink()">Load link into editor</button>
                    <div class="form-floating mb-3">
                        <input type="url" class="form-control" id="calurl" oninput="onInputHandler()">
                        <label for="calurl">Calendar URL</label>
                    </div>
                     <div class="form-floating mb-3">
                         <input type="text" class="form-control" id="allowlist" oninput="onInputHandler()">
                        <label for="allowlist">Allowlist</label>
                        <small class="text-muted">Use comma to separate multiple filters</small>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="blacklist" oninput="onInputHandler()">
                        <label for="blacklist">Blacklist (optional)</label>
                        <small class="text-muted">Use comma to separate multiple filters</small>
                    </div>
                    <hr class="my-4">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="shorten" onchange="onInputHandler()">
                        <label class="form-check-label" for="shorten">
                            Create short link (uses cached payload)
                        </label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="url" class="form-control" id="filteredurl" readonly>
                        <label for="filteredurl">New filtered calendar URL</label>
                    </div>
                    <button type="button" class="w-100 btn btn-lg btn-primary" id="copybtn" onclick="copy()" disabled>
                        Copy to clipboard
                    </button>

                    <small class="text-muted">If the button does not work you can select the new URL and
                        copy it
                        manually</small>
                </form>
            </div>
            <div class="col-lg-7 text-center text-lg-start">
                <p class="col-lg-6 fs-4">How does it work?</p>
                 <p class="lead text-muted">On every request the remote iCal file is fetched directly from the remote
                     server and parsed, after that the calendar is returned as-is with only events that match the allowed
                     keywords and do not contain any of the blocked words. All the data about the request is stored in
                     the URL and is never stored on the server. If you enable short links, request data is cached
                     locally to provide a shorter URL. You can also combine up to five calendars with their own filters and optionally request a short link for the bundle.</p>
                <p class="lead text-muted">The code is open source under MIT license and available on <a
                        href="https://github.com/OpenCirclePkgs/fical">GitHub</a></p>
            </div>
        </div>
        <hr>
        <div class="row mt-4">
            <div class="col-lg-12">
                <h2 class="h4 mb-3">Combine multiple calendars (max 5)</h2>
                <div id="multi-cal-list" class="mb-3"></div>
                <div class="d-flex gap-2 mb-3">
                    <button type="button" class="btn btn-outline-primary" onclick="addCalendarRow()">Add calendar</button>
                    <button type="button" class="btn btn-outline-danger" onclick="removeCalendarRow()">Remove last</button>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="multishorten">
                    <label class="form-check-label" for="multishorten">
                        Create short link for combined calendar (recommended)
                    </label>
                </div>
                <button type="button" class="btn btn-success mb-3" onclick="generateCombined()">Generate combined</button>
                <div class="form-floating mb-3">
                    <input type="url" class="form-control" id="combinedOutput" readonly>
                    <label for="combinedOutput">Combined calendar link (short or downloadable)</label>
                </div>
                <button type="button" class="btn btn-primary" id="copyCombined" onclick="copyCombined()" disabled>Copy combined link</button>
                <small class="text-muted d-block mt-2">When not using short links a temporary download link is generated for the merged calendar.</small>
            </div>
        </div>
    </div>


</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

<script>
    const EMPTY_ALLOWLIST_TOKEN = "__empty_allowlist__"
    const MAX_CAL = 5
    const multiCalList = []

    function onInputHandler() {
        const calurlstr = document.getElementById('calurl').value
        const allowliststr = document.getElementById('allowlist').value
        const blackliststr = document.getElementById('blacklist').value
        let newURL = ""

        if (calurlstr && (allowliststr || blackliststr)) {
            const allowlistEncoded = encodeToBase64url(allowliststr || EMPTY_ALLOWLIST_TOKEN)
            const baseURL = window.location.origin + "/calendar/" + encodeToBase64url(calurlstr) + "/" + allowlistEncoded + "/filtered.ics"
            if (blackliststr) {
                newURL = baseURL + "?b64blocklist=" + encodeToBase64url(blackliststr)
            } else {
                newURL = baseURL
            }
        }
        document.getElementById("filteredurl").value = newURL
        document.getElementById('copybtn').disabled = !newURL
    }

    function loadExistingLink() {
        const link = document.getElementById("existinglink").value.trim()
        if (!link) return
        try {
            const url = new URL(link)
            const parts = url.pathname.split("/")
            if (parts.length >= 4 && parts[1] === "calendar") {
                const encodedUrl = parts[2]
                const encodedAllow = parts[3]
                const blockParam = url.searchParams.get("b64blocklist") || ""
                document.getElementById("calurl").value = decodeFromBase64url(encodedUrl)
                const allowDecoded = decodeFromBase64url(encodedAllow)
                document.getElementById("allowlist").value = allowDecoded === EMPTY_ALLOWLIST_TOKEN ? "" : allowDecoded
                document.getElementById("blacklist").value = blockParam ? decodeFromBase64url(blockParam) : ""
                onInputHandler()
            } else if (parts.length >= 3 && parts[1] === "s") {
                document.getElementById("combinedOutput").value = link
                document.getElementById("copyCombined").disabled = false
            }
        } catch (e) {
            alert("Could not parse link")
        }
    }

    function addCalendarRow() {
        if (multiCalList.length >= MAX_CAL) {
            alert("Maximum of 5 calendars")
            return
        }
        const idx = multiCalList.length
        const container = document.createElement("div")
        container.className = "card p-3 mb-2"
        container.id = `multi-${idx}`
        container.innerHTML = `
            <div class="row g-2">
                <div class="col-md-5">
                    <input type="url" class="form-control" placeholder="Calendar URL" data-field="url">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Allowlist (comma)" data-field="allowlist">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Blocklist (comma)" data-field="blocklist">
                </div>
            </div>`
        document.getElementById("multi-cal-list").appendChild(container)
        multiCalList.push(container)
    }

    function removeCalendarRow() {
        const el = multiCalList.pop()
        if (el) {
            el.remove()
        }
    }

    async function generateCombined() {
        const payload = {calendars: [], short: document.getElementById("multishorten").checked}
        multiCalList.forEach(card => {
            const url = card.querySelector('[data-field="url"]').value.trim()
            const allowlist = card.querySelector('[data-field="allowlist"]').value.split(",").map(s => s.trim()).filter(Boolean)
            const blocklist = card.querySelector('[data-field="blocklist"]').value.split(",").map(s => s.trim()).filter(Boolean)
            if (url) {
                payload.calendars.push({url, allowlist, blocklist})
            }
        })
        if (!payload.calendars.length) {
            alert("Add at least one calendar")
            return
        }
        if (payload.calendars.length > MAX_CAL) {
            alert("Maximum of 5 calendars")
            return
        }
        let resp
        try {
            resp = await fetch("/calendars/combined.ics", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            })
        } catch (e) {
            alert("Network error while generating combined calendar")
            return
        }
        if (!resp.ok) {
            alert("Failed to generate combined calendar")
            return
        }
        if (payload.short) {
            const data = await resp.json()
            document.getElementById("combinedOutput").value = data.short
        } else {
            const blob = await resp.blob()
            const url = URL.createObjectURL(blob)
            document.getElementById("combinedOutput").value = url
        }
        document.getElementById("copyCombined").disabled = !document.getElementById("combinedOutput").value
    }

    function copyCombined() {
        const val = document.getElementById("combinedOutput").value
        if (!val) return
        if (navigator.clipboard) {
            navigator.clipboard.writeText(val)
        }
    }

    function copy() {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(document.getElementById("filteredurl").value).then(() => {
                document.getElementById('copybtn').value = "URL Copied!";
                alert("Copied!")
            }, (err) => {
                document.getElementById('copybtn').value = "Failed to copy the text to clipboard."
            });
        }
    }
    function base64ToBase64url(input) {
      // Replace non-url compatible chars with base64url standard chars and remove leading =
      return input
        .replace(/\+/g, '_')
        .replace(/\//g, '-')
        .replace(/=+$/g, '');
    }

    function encodeToBase64url(input) {
      const bytes = new TextEncoder().encode(input)
      let binary = ""
      bytes.forEach((b) => {
        binary += String.fromCharCode(b)
      })
      return base64ToBase64url(btoa(binary));
    }

    function decodeFromBase64url(input) {
        let b64 = input.replace(/-/g, "+").replace(/_/g, "/")
        while (b64.length % 4) {
            b64 += "="
        }
        try {
            return atob(b64)
        } catch (_) {
            return ""
        }
    }

    // initialize with one row
    addCalendarRow()
</script>

</body>
</html>
